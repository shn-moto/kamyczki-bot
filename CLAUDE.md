# kamyczki-bot

Telegram –±–æ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞—Å–∫—Ä–∞—à–µ–Ω–Ω—ã—Ö –∫–∞–º–Ω–µ–π (painted rocks). –ö–∞–º–Ω–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –ø–æ —Ñ–æ—Ç–æ, —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ CLIP —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL —Å pgvector.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
src/
‚îú‚îÄ‚îÄ main.py              # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ + web —Å–µ—Ä–≤–µ—Ä–∞
‚îú‚îÄ‚îÄ config.py            # Pydantic Settings (.env)
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îî‚îÄ‚îÄ handlers.py      # Telegram ConversationHandler
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ models.py        # SQLAlchemy: Stone, StoneHistory
‚îÇ   ‚îî‚îÄ‚îÄ connection.py    # AsyncPG connection
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ clip_service.py  # CLIP ViT-B/32 + rembg –∫—Ä–æ–ø
‚îÇ   ‚îú‚îÄ‚îÄ map_service.py   # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PNG –∫–∞—Ä—Ç—ã (staticmap)
‚îÇ   ‚îú‚îÄ‚îÄ geocoding.py     # Nominatim reverse/forward geocoding
‚îÇ   ‚îî‚îÄ‚îÄ exif.py          # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ GPS –∏–∑ EXIF
‚îî‚îÄ‚îÄ web/
    ‚îú‚îÄ‚îÄ app.py           # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    ‚îú‚îÄ‚îÄ routes.py        # API endpoints –¥–ª—è Mini App
    ‚îî‚îÄ‚îÄ static/
        ‚îú‚îÄ‚îÄ index.html   # Telegram Mini App (Leaflet.js)
        ‚îú‚îÄ‚îÄ map.js       # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        ‚îî‚îÄ‚îÄ style.css    # –°—Ç–∏–ª–∏
```

## –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–ª–æ—É

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–∞–º–µ–Ω—å:
1. –§–æ—Ç–æ ‚Üí `context.user_data.clear()` ‚Üí **rembg –∫—Ä–æ–ø** ‚Üí CLIP –¥–µ—Ç–µ–∫—Ü–∏—è
2. –ü–æ–∏—Å–∫ –ø–æ —ç–º–±–µ–¥–¥–∏–Ω–≥—É (cosine similarity >= 0.83)
3. **–ú–∏–Ω–∏–∞—Ç—é—Ä–∞ –∫—Ä–æ–ø–∞** + "–ö–∞–º–µ–Ω—å –Ω–∞–π–¥–µ–Ω!" + –∫–Ω–æ–ø–∫–∏: –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è / ZIP / –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
4. –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∏–ª–∏ ZIP –∫–æ–¥ ‚Üí –≥–µ–æ–∫–æ–¥–∏–Ω–≥ ‚Üí –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
5. "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!" + **PNG –∫–∞—Ä—Ç–∞** + **–∫–Ω–æ–ø–∫–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã (Mini App)**

### –ù–æ–≤—ã–π –∫–∞–º–µ–Ω—å:
1. –§–æ—Ç–æ ‚Üí **rembg –∫—Ä–æ–ø** ‚Üí CLIP –¥–µ—Ç–µ–∫—Ü–∏—è ‚Üí —ç–º–±–µ–¥–¥–∏–Ω–≥
2. **–ú–∏–Ω–∏–∞—Ç—é—Ä–∞ –∫—Ä–æ–ø–∞** + "–ù–æ–≤—ã–π –∫–∞–º–µ–Ω—å!" ‚Üí –≤–≤–æ–¥ –∏–º–µ–Ω–∏ ‚Üí –æ–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
3. –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∏–ª–∏ ZIP –∫–æ–¥ ‚Üí —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ë–î

## –£–º–Ω—ã–π –∫—Ä–æ–ø –∫–∞–º–Ω—è

- **rembg** (U2-Net) ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∫–∞–º–Ω—è
- `smart_crop_stone()` –≤ clip_service.py:
  - –£–¥–∞–ª—è–µ—Ç —Ñ–æ–Ω —á–µ—Ä–µ–∑ rembg
  - –ù–∞—Ö–æ–¥–∏—Ç bounding box –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π
  - –ö—Ä–æ–ø–∏—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª —Å padding 20px
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—Ä–æ–ø + –º–∏–Ω–∏–∞—Ç—é—Ä—É 200x200
- –≠–º–±–µ–¥–¥–∏–Ω–≥ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏–∑ –∫—Ä–æ–ø–Ω—É—Ç–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ª—É—á—à–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–∞)
- –ú–∏–Ω–∏–∞—Ç—é—Ä–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

## –ö–∞—Ä—Ç–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π

- **staticmap** ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è PNG –∫–∞—Ä—Ç—ã —Å OSM —Ç–∞–π–ª–∞–º–∏
- –ú–∞—Ä–∫–µ—Ä—ã: üü¢ —Å—Ç–∞—Ä—Ç, üîµ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ, üî¥ —Ñ–∏–Ω–∏—à
- –õ–∏–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑—É–º –ø–æ–¥ –≤—Å–µ —Ç–æ—á–∫–∏
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ —Ñ–æ—Ç–æ –≤ –∫–æ–Ω—Ü–µ —Ñ–ª–æ—É (–ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é)

**–ü–æ—á–µ–º—É PNG, –∞ –Ω–µ HTML:** Telegram –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π HTML, –∞ iOS Safari –±–ª–æ–∫–∏—Ä—É–µ—Ç CDN-—Ä–µ—Å—É—Ä—Å—ã –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö HTML —Ñ–∞–π–ª–∞—Ö.

## Telegram Mini App (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞)

- **FastAPI** web —Å–µ—Ä–≤–µ—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º daemon-–ø–æ—Ç–æ–∫–µ
- **Leaflet.js** –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã —Å OSM —Ç–∞–π–ª–∞–º–∏
- –ö–Ω–æ–ø–∫–∞ "üó∫ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞" –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App –≤ Telegram
- API endpoint: `GET /api/stones/{stone_id}/map-data`
- –¢—Ä–µ–±—É–µ—Ç HTTPS –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ Telegram

### HTTPS —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```bash
# cloudflared (–±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
"C:\Program Files (x86)\cloudflared\cloudflared.exe" tunnel --url http://localhost:8080

# –∏–ª–∏ ngrok (—Ç—Ä–µ–±—É–µ—Ç authtoken)
ngrok http 8080
```

URL —Ç—É–Ω–Ω–µ–ª—è —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ `.env`:
```
WEBAPP_BASE_URL=https://xxx.trycloudflare.com
```

### –ò–∑–æ–ª—è—Ü–∏—è event loop

**–í–ê–ñ–ù–û:** FastAPI —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ —Å–æ —Å–≤–æ–∏–º event loop. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `get_async_session()` –∏–∑ –±–æ—Ç–∞ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É "Task got Future attached to a different loop".

–†–µ—à–µ–Ω–∏–µ –≤ `routes.py`: –æ—Ç–¥–µ–ª—å–Ω—ã–π engine –∏ session maker:
```python
_web_engine = None
_web_session_maker = None

def get_web_session():
    global _web_engine, _web_session_maker
    if _web_engine is None:
        _web_engine = create_async_engine(settings.database_url)
        _web_session_maker = async_sessionmaker(_web_engine)
    return _web_session_maker()
```

## –ì–µ–æ–∫–æ–¥–∏–Ω–≥

- **Nominatim API** (OpenStreetMap)
- Reverse geocoding: GPS ‚Üí –∞–¥—Ä–µ—Å (`get_location_from_gps`)
- Forward geocoding: ZIP –∫–æ–¥ ‚Üí –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (`get_coords_from_zip`)
- User-Agent: `kamyczki-bot/1.0`

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

- **PostgreSQL 16 + pgvector** (docker-compose.yml)
- –¢–∞–±–ª–∏—Ü–∞ `stones`: id, name, description, photo_file_id, embedding(512), registered_by_user_id
- –¢–∞–±–ª–∏—Ü–∞ `stone_history`: id, stone_id, telegram_user_id, photo_file_id, lat, lon, zip_code, created_at

## –ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

- `SIMILARITY_THRESHOLD = 0.83` (handlers.py) ‚Äî –ø–æ—Ä–æ–≥ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
- CLIP –º–æ–¥–µ–ª—å: `ViT-B-32` pretrained `laion2b_s34b_b79k` ‚Äî 512-dim vectors
- Stone detection threshold: `0.05` (clip_service.py)
- Web server port: `8080` (config.py: `web_port`)
- Mini App URL: `.env` ‚Üí `WEBAPP_BASE_URL`

### –ü–æ–¥–±–æ—Ä –ø–æ—Ä–æ–≥–∞ similarity

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 22 –∫–∞–º–Ω—è—Ö –ø–æ–∫–∞–∑–∞–ª–æ:
- **–ò–¥–µ–Ω—Ç–∏—á–Ω—ã–π –∫–∞–º–µ–Ω—å** (—Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ç–æ): ~0.85-0.99
- **–†–∞–∑–Ω—ã–µ –∫–∞–º–Ω–∏**: ~0.50-0.82

| –ü–æ—Ä–æ–≥ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|-------|-----------|
| 0.70 | False positives: –ø–æ—Ö–æ–∂–∏–π —Ñ–æ–Ω |
| 0.80 | False positives: —è—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞ |
| 0.88 | –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –º–∞—Ç—á–∏ |
| 0.85 | –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –º–∞—Ç—á–∏ |
| 0.84 | –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –º–∞—Ç—á–∏ |
| **0.83** | ‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å |

–ó–∞–∑–æ—Ä –º–µ–∂–¥—É "—Å–≤–æ–π" –∏ "—á—É–∂–æ–π" –∫–∞–º–µ–Ω—å ~0.02, –ø–æ–¥–±–æ—Ä –ø–æ—Ä–æ–≥–∞ –∫—Ä–∏—Ç–∏—á–µ–Ω.

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ pgvector + asyncpg

**–í–ê–ñ–ù–û:** `order_by(Stone.embedding.cosine_distance(python_list))` –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç —Å asyncpg ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ SQL –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

–†–µ—à–µ–Ω–∏–µ –≤ `find_similar_stone()`: –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–∞–º–Ω–∏ –∏ –≤—ã—á–∏—Å–ª—è–µ–º distance –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º:
```python
for stone in stones:
    distance_result = await session.execute(
        select(Stone.embedding.cosine_distance(embedding))
        .where(Stone.id == stone.id)
    )
```

## –ó–∞–ø—É—Å–∫

```bash
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
docker-compose up -d

# –ë–æ—Ç
.venv\Scripts\python.exe -m src.main

# –†–µ—Å—Ç–∞—Ä—Ç (Windows) ‚Äî —É–±–∏–≤–∞–µ—Ç –≤—Å–µ python.exe, –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ
restart.bat
```

–õ–æ–≥-—Ñ–∞–π–ª: `logs/bot.log`

## TODO / –ò–¥–µ–∏

- [x] ~~–ö—Ä–æ–ø –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ –≥—Ä–∞–Ω–∏—Ü –∫–∞–º–Ω—è –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥–∞~~ (rembg)
- [x] ~~Telegram Mini App –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã~~ (Leaflet.js + FastAPI + cloudflared)
- [x] ~~ZIP –∫–æ–¥ –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏~~ (–¥–ª—è Telegram Desktop)
- [ ] –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ GPS –∏–∑ EXIF —Ñ–æ—Ç–æ (—Å–µ—Ä–≤–∏—Å –µ—Å—Ç—å, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ handlers)
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∫–∞–º–Ω–µ–π (—Å–µ–π—á–∞—Å O(n) –∑–∞–ø—Ä–æ—Å–æ–≤)
- [ ] –ü—Ä–æ–¥–∞–∫—à–Ω —Ö–æ—Å—Ç–∏–Ω–≥ Mini App (Vercel, Railway, etc.)
