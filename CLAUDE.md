# kamyczki-bot

Telegram ะฑะพั ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั ัะฐัะบัะฐัะตะฝะฝัั ะบะฐะผะฝะตะน (painted rocks). ะะฐะผะฝะธ ัะตะณะธัััะธัััััั ะฟะพ ัะพัะพ, ัะฐัะฟะพะทะฝะฐัััั ัะตัะตะท CLIP ัะผะฑะตะดะดะธะฝะณะธ ะธ ััะฐะฝัััั ะฒ PostgreSQL ั pgvector.

## ะััะธัะตะบัััะฐ

```
src/
โโโ main.py              # ะขะพัะบะฐ ะฒัะพะดะฐ, ะทะฐะฟััะบ ะฑะพัะฐ + web ัะตัะฒะตัะฐ
โโโ config.py            # Pydantic Settings (.env)
โโโ bot/
โ   โโโ handlers.py      # Telegram ConversationHandler
โโโ database/
โ   โโโ models.py        # SQLAlchemy: Stone, StoneHistory
โ   โโโ connection.py    # AsyncPG connection
โโโ services/
โ   โโโ clip_service.py  # CLIP ViT-B/32 + rembg ะบัะพะฟ
โ   โโโ map_service.py   # ะะตะฝะตัะฐัะธั PNG ะบะฐััั (staticmap)
โ   โโโ geocoding.py     # Nominatim reverse/forward geocoding
โ   โโโ exif.py          # ะะทะฒะปะตัะตะฝะธะต GPS ะธะท EXIF
โโโ web/
    โโโ app.py           # FastAPI ะฟัะธะปะพะถะตะฝะธะต
    โโโ routes.py        # API endpoints ะดะปั Mini App
    โโโ static/
        โโโ index.html   # Telegram Mini App (Leaflet.js)
        โโโ map.js       # ะะฝะธัะธะฐะปะธะทะฐัะธั ะบะฐััั
        โโโ style.css    # ะกัะธะปะธ
```

## ะัะฝะพะฒะฝะพะน ัะปะพั

### ะกััะตััะฒัััะธะน ะบะฐะผะตะฝั:
1. ะคะพัะพ โ `context.user_data.clear()` โ **rembg ะบัะพะฟ** โ CLIP ะดะตัะตะบัะธั
2. ะะพะธัะบ ะฟะพ ัะผะฑะตะดะดะธะฝะณั (cosine similarity >= 0.83)
3. **ะะธะฝะธะฐัััะฐ ะบัะพะฟะฐ** + "ะะฐะผะตะฝั ะฝะฐะนะดะตะฝ!" + ะบะฝะพะฟะบะธ: ะณะตะพะปะพะบะฐัะธั / ZIP / ะฟัะพะฟัััะธัั
4. ะะตะพะปะพะบะฐัะธั ะธะปะธ ZIP ะบะพะด โ ะณะตะพะบะพะดะธะฝะณ โ ะดะพะฑะฐะฒะปะตะฝะธะต ะฒ ะธััะพัะธั
5. "ะกะพััะฐะฝะตะฝะพ!" + **PNG ะบะฐััะฐ** + **ะบะฝะพะฟะบะฐ ะธะฝัะตัะฐะบัะธะฒะฝะพะน ะบะฐััั (Mini App)**

### ะะพะฒัะน ะบะฐะผะตะฝั:
1. ะคะพัะพ โ **rembg ะบัะพะฟ** โ CLIP ะดะตัะตะบัะธั โ ัะผะฑะตะดะดะธะฝะณ
2. **ะะธะฝะธะฐัััะฐ ะบัะพะฟะฐ** + "ะะพะฒัะน ะบะฐะผะตะฝั!" โ ะฒะฒะพะด ะธะผะตะฝะธ โ ะพะฟะธัะฐะฝะธะต (ะพะฟัะธะพะฝะฐะปัะฝะพ)
3. ะะตะพะปะพะบะฐัะธั ะธะปะธ ZIP ะบะพะด โ ัะตะณะธัััะฐัะธั ะฒ ะะ

## ะฃะผะฝัะน ะบัะพะฟ ะบะฐะผะฝั

- **rembg** (U2-Net) โ ัะดะฐะปะตะฝะธะต ัะพะฝะฐ ะดะปั ะฒัะดะตะปะตะฝะธั ะบะฐะผะฝั
- `smart_crop_stone()` ะฒ clip_service.py:
  - ะฃะดะฐะปัะตั ัะพะฝ ัะตัะตะท rembg
  - ะะฐัะพะดะธั bounding box ะฝะตะฟัะพะทัะฐัะฝัั ะฟะธะบัะตะปะตะน
  - ะัะพะฟะธั ะพัะธะณะธะฝะฐะป ั padding 20px
  - ะะพะทะฒัะฐัะฐะตั ะบัะพะฟ + ะผะธะฝะธะฐัััั 200x200
- ะญะผะฑะตะดะดะธะฝะณ ัะพะทะดะฐัััั ะธะท ะบัะพะฟะฝััะพะณะพ ะธะทะพะฑัะฐะถะตะฝะธั (ะปัััะต ะบะฐัะตััะฒะพ ะฟะพะธัะบะฐ)
- ะะธะฝะธะฐัััะฐ ะพัะฟัะฐะฒะปัะตััั ะฟะพะปัะทะพะฒะฐัะตะปั ะดะปั ะฒะธะทัะฐะปัะฝะพะน ะฟัะพะฒะตัะบะธ

## ะะฐััะฐ ะฟะตัะตะผะตัะตะฝะธะน

- **staticmap** โ ะณะตะฝะตัะฐัะธั PNG ะบะฐััั ั OSM ัะฐะนะปะฐะผะธ
- ะะฐัะบะตัั: ๐ข ััะฐัั, ๐ต ะฟัะพะผะตะถััะพัะฝัะต, ๐ด ัะธะฝะธั
- ะะธะฝะธั ะผะฐัััััะฐ ะผะตะถะดั ัะพัะบะฐะผะธ
- ะะฒัะพะผะฐัะธัะตัะบะธะน ะทัะผ ะฟะพะด ะฒัะต ัะพัะบะธ
- ะัะฟัะฐะฒะปัะตััั ะบะฐะบ ัะพัะพ ะฒ ะบะพะฝัะต ัะปะพั (ะฟะพัะปะต ะดะพะฑะฐะฒะปะตะฝะธั ะฒ ะธััะพัะธั)

**ะะพัะตะผั PNG, ะฐ ะฝะต HTML:** Telegram ะฝะต ัะตะฝะดะตัะธั ะธะฝัะตัะฐะบัะธะฒะฝัะน HTML, ะฐ iOS Safari ะฑะปะพะบะธััะตั CDN-ัะตััััั ะฒ ะปะพะบะฐะปัะฝัั HTML ัะฐะนะปะฐั.

## Telegram Mini App (ะธะฝัะตัะฐะบัะธะฒะฝะฐั ะบะฐััะฐ)

- **FastAPI** web ัะตัะฒะตั ะฒ ะพัะดะตะปัะฝะพะผ daemon-ะฟะพัะพะบะต
- **Leaflet.js** ะดะปั ะธะฝัะตัะฐะบัะธะฒะฝะพะน ะบะฐััั ั OSM ัะฐะนะปะฐะผะธ
- ะะฝะพะฟะบะฐ "๐บ ะะฝัะตัะฐะบัะธะฒะฝะฐั ะบะฐััะฐ" ะพัะบััะฒะฐะตั Mini App ะฒ Telegram
- API endpoint: `GET /api/stones/{stone_id}/map-data`
- ะขัะตะฑัะตั HTTPS ะดะปั ัะฐะฑะพัั ะฒ Telegram

### HTTPS ััะฝะฝะตะปั ะดะปั ัะฐะทัะฐะฑะพัะบะธ

```bash
# cloudflared (ะฑะตะท ัะตะณะธัััะฐัะธะธ)
"C:\Program Files (x86)\cloudflared\cloudflared.exe" tunnel --url http://localhost:8080

# ะธะปะธ ngrok (ััะตะฑัะตั authtoken)
ngrok http 8080
```

URL ััะฝะฝะตะปั ัะบะฐะทัะฒะฐะตััั ะฒ `.env`:
```
WEBAPP_BASE_URL=https://xxx.trycloudflare.com
```

### ะะทะพะปััะธั event loop

**ะะะะะ:** FastAPI ัะฐะฑะพัะฐะตั ะฒ ะพัะดะตะปัะฝะพะผ ะฟะพัะพะบะต ัะพ ัะฒะพะธะผ event loop. ะัะฟะพะปัะทะพะฒะฐะฝะธะต `get_async_session()` ะธะท ะฑะพัะฐ ะฒัะทะพะฒะตั ะพัะธะฑะบั "Task got Future attached to a different loop".

ะะตัะตะฝะธะต ะฒ `routes.py`: ะพัะดะตะปัะฝัะน engine ะธ session maker:
```python
_web_engine = None
_web_session_maker = None

def get_web_session():
    global _web_engine, _web_session_maker
    if _web_engine is None:
        _web_engine = create_async_engine(settings.database_url)
        _web_session_maker = async_sessionmaker(_web_engine)
    return _web_session_maker()
```

## ะะตะพะบะพะดะธะฝะณ

- **Nominatim API** (OpenStreetMap)
- Reverse geocoding: GPS โ ะฐะดัะตั (`get_location_from_gps`)
- Forward geocoding: ZIP ะบะพะด โ ะบะพะพัะดะธะฝะฐัั (`get_coords_from_zip`)
- User-Agent: `kamyczki-bot/1.0`

## ะะฐะทะฐ ะดะฐะฝะฝัั

- **PostgreSQL 16 + pgvector** (docker-compose.yml)
- ะขะฐะฑะปะธัะฐ `stones`: id, name, description, photo_file_id, embedding(512), registered_by_user_id
- ะขะฐะฑะปะธัะฐ `stone_history`: id, stone_id, telegram_user_id, photo_file_id, lat, lon, zip_code, created_at

## ะะปััะตะฒัะต ะฟะฐัะฐะผะตััั

- `SIMILARITY_THRESHOLD = 0.83` (handlers.py) โ ะฟะพัะพะณ ะดะปั ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั
- CLIP ะผะพะดะตะปั: `ViT-B-32` pretrained `laion2b_s34b_b79k` โ 512-dim vectors
- Stone detection threshold: `0.05` (clip_service.py)
- Web server port: `8080` (config.py: `web_port`)
- Mini App URL: `.env` โ `WEBAPP_BASE_URL`

### ะะพะดะฑะพั ะฟะพัะพะณะฐ similarity

ะขะตััะธัะพะฒะฐะฝะธะต ะฝะฐ 22 ะบะฐะผะฝัั ะฟะพะบะฐะทะฐะปะพ:
- **ะะดะตะฝัะธัะฝัะน ะบะฐะผะตะฝั** (ัะฐะทะฝัะต ัะพัะพ): ~0.85-0.99
- **ะะฐะทะฝัะต ะบะฐะผะฝะธ**: ~0.50-0.82

| ะะพัะพะณ | ะะตะทัะปััะฐั |
|-------|-----------|
| 0.70 | False positives: ะฟะพัะพะถะธะน ัะพะฝ |
| 0.80 | False positives: ััะบะธะต ัะฒะตัะฐ |
| 0.88 | ะัะพะฟััะบะฐะตั ะผะฐััะธ |
| 0.85 | ะัะพะฟััะบะฐะตั ะผะฐััะธ |
| 0.84 | ะัะพะฟััะบะฐะตั ะผะฐััะธ |
| **0.83** | โ ะะฟัะธะผะฐะปัะฝัะน ะฑะฐะปะฐะฝั |

ะะฐะทะพั ะผะตะถะดั "ัะฒะพะน" ะธ "ััะถะพะน" ะบะฐะผะตะฝั ~0.02, ะฟะพะดะฑะพั ะฟะพัะพะณะฐ ะบัะธัะธัะตะฝ.

## ะะทะฒะตััะฝัะต ะพัะพะฑะตะฝะฝะพััะธ pgvector + asyncpg

**ะะะะะ:** `order_by(Stone.embedding.cosine_distance(python_list))` ะะ ัะฐะฑะพัะฐะตั ั asyncpg โ ะฟะฐัะฐะผะตัั ะฝะต ะฟะตัะตะดะฐะตััั ะฒ SQL ะบะพััะตะบัะฝะพ.

ะะตัะตะฝะธะต ะฒ `find_similar_stone()`: ะฟะพะปััะฐะตะผ ะฒัะต ะบะฐะผะฝะธ ะธ ะฒััะธัะปัะตะผ distance ะดะปั ะบะฐะถะดะพะณะพ ะพัะดะตะปัะฝัะผ ะทะฐะฟัะพัะพะผ:
```python
for stone in stones:
    distance_result = await session.execute(
        select(Stone.embedding.cosine_distance(embedding))
        .where(Stone.id == stone.id)
    )
```

## ะะฐะฟััะบ

### Docker (ัะตะบะพะผะตะฝะดัะตััั)

```bash
# ะะปะพะฝะธัะพะฒะฐัั ะธ ะฝะฐัััะพะธัั
git clone https://github.com/shn-moto/kamyczki-bot.git
cd kamyczki-bot
cp .env.example .env
nano .env  # ัััะฐะฝะพะฒะธัั TELEGRAM_BOT_TOKEN

# ะะฐะฟัััะธัั ะฒัั (postgres + bot + cloudflared)
docker-compose up -d

# ะะพัะผะพััะตัั URL ััะฝะฝะตะปั
docker logs kamyczki-tunnel 2>&1 | grep https://

# ะะพะณะธ ะฑะพัะฐ
docker logs -f kamyczki-bot
```

**ะััะธัะตะบัััะฐ Docker:**
```
โโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโ
โ cloudflared โโโโโโถโ     bot     โโโโโโถโ  postgres   โ
โ   HTTPS     โ     โ   :8080     โ     โ   pgvector  โ
โโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโ
```

### ะะพะบะฐะปัะฝะฐั ัะฐะทัะฐะฑะพัะบะฐ (Windows)

```bash
# ะะฐะทะฐ ะดะฐะฝะฝัั
docker-compose up -d postgres

# ะะพั
.venv\Scripts\python.exe -m src.main

# ะะตััะฐัั โ ัะฑะธะฒะฐะตั ะฒัะต python.exe, ะทะฐะฟััะบะฐะตั ะฑะพัะฐ ะฒ ัะพะฝะต
restart.bat
```

ะะพะณ-ัะฐะนะป: `logs/bot.log`

### Linux (systemd)

```bash
sudo bash deploy/install.sh
sudo systemctl start cloudflared kamyczki-bot
```

## TODO / ะะดะตะธ

- [x] ~~ะัะพะฟ ะธะทะพะฑัะฐะถะตะฝะธั ะดะพ ะณัะฐะฝะธั ะบะฐะผะฝั ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ ัะผะฑะตะดะดะธะฝะณะฐ~~ (rembg)
- [x] ~~Telegram Mini App ะดะปั ะธะฝัะตัะฐะบัะธะฒะฝะพะน ะบะฐััั~~ (Leaflet.js + FastAPI + cloudflared)
- [x] ~~ZIP ะบะพะด ะบะฐะบ ะฐะปััะตัะฝะฐัะธะฒะฐ ะณะตะพะปะพะบะฐัะธะธ~~ (ะดะปั Telegram Desktop)
- [x] ~~Docker deployment~~ (docker-compose + cloudflared)
- [ ] ะะทะฒะปะตัะตะฝะธะต GPS ะธะท EXIF ัะพัะพ (ัะตัะฒะธั ะตััั, ะฝะพ ะฝะต ะธัะฟะพะปัะทัะตััั ะฒ handlers)
- [ ] ะะฟัะธะผะธะทะฐัะธั ะฟะพะธัะบะฐ ะฟัะธ ะฑะพะปััะพะผ ะบะพะปะธัะตััะฒะต ะบะฐะผะฝะตะน (ัะตะนัะฐั O(n) ะทะฐะฟัะพัะพะฒ)
